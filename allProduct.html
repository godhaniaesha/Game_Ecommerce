<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Games Store</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/s_style.css" />
    <link rel="stylesheet" href="./css/z_style.css" />
    <link rel="stylesheet" href="./css/d_style.css">
    <style>
        .offcanvas {
            --bs-offcanvas-width: 350px;
            background-color: #1a1a1a;
        }

        @media (max-width: 991px) {
            .a_header_container {
                padding: 0px 8% !important;
            }
        }

        @media (max-width:375px) {
            .offcanvas {
                --bs-offcanvas-width: 300px;
            }
        }

        @media (max-width:320px) {
            .offcanvas {
                --bs-offcanvas-width: 280px;
            }
        }
    </style>
</head>

<body>
    <div class="d_main">
        <!-- Header -->
        <header class="d_header d-flex align-items-center justify-content-between">
            <div class="d_logo">
                <img src="./images/yoyo logo done.png" style="padding: 7px; height: 60px;" alt="logo" class="img-fluid">
            </div>

            <!-- Desktop Nav -->
            <nav class="d_navbar navbar navbar-expand-lg d-none d-lg-flex">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link " href="landingpage.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="allProduct.html">Games</a></li>
                    <li class="nav-item"><a class="nav-link" href="About_us.html">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="./Contact_us.html">Contact</a></li>
                    <li class="nav-item px-2">
                        <!-- Chat Open Button -->
                        <button class="d_search_form btn_gem" id="chatToggleNav">
                            Chatbox
                        </button>
                    </li>

                    <!-- Chatbox -->
                    <div class="chatbox" id="chatbox">
                        <div class="chatbox-header">
                            ðŸŽ® GameStore AI
                            <span id="closeChat">âœ–</span>
                        </div>
                        <div class="chatbox-messages" id="chatMessages">
                            <div class="message bot">Hi! Iâ€™m your gaming assistant. How can I help you today?</div>
                        </div>
                        <div class="chatbox-input">
                            <input type="text" id="userInput" placeholder="Type your message...">
                            <button id="sendMessage">âž¤</button>
                        </div>
                    </div>

                    <script>
                        const chatToggleNav = document.getElementById("chatToggleNav");
                        const chatbox = document.getElementById("chatbox");
                        const closeChat = document.getElementById("closeChat");
                        const sendMessageBtn = document.getElementById("sendMessage");
                        const userInput = document.getElementById("userInput");
                        const chatMessages = document.getElementById("chatMessages");

                        // Open chat from navbar button
                        chatToggleNav.addEventListener("click", () => {
                            chatbox.style.display = "flex";
                        });

                        // Close chat
                        closeChat.addEventListener("click", () => {
                            chatbox.style.display = "none";
                        });

                        // Send message
                        function sendMessage() {
                            const message = userInput.value.trim();
                            if (message === "") return;

                            appendMessage(message, "user");
                            userInput.value = "";

                            setTimeout(() => {
                                let reply = getBotReply(message);
                                appendMessage(reply, "bot");
                            }, 800);
                        }

                        function appendMessage(text, sender) {
                            const msg = document.createElement("div");
                            msg.classList.add("message", sender);
                            msg.innerText = text;
                            chatMessages.appendChild(msg);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }

                        function getBotReply(userMsg) {
                            userMsg = userMsg.toLowerCase();
                            if (userMsg.includes("game")) return "We have the latest trending games! ðŸŽ®";
                            if (userMsg.includes("offer") || userMsg.includes("discount")) return "Check out our deals page for discounts up to 50%! ðŸ”¥";
                            if (userMsg.includes("console")) return "We sell PS5, Xbox Series X, and Nintendo Switch consoles.";
                            return "Iâ€™m not sure, but I can connect you to a human agent. ðŸ˜Š";
                        }

                        sendMessageBtn.addEventListener("click", sendMessage);
                        userInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });
                    </script>
                </ul>

                <form class="d_search_form ">
                    <input type="search" placeholder="Search games..." />
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>

                <div class="d_social_icons me-3">
                    <a href="./Cart.html"><i class="fa fa-cart-plus"></i></a>
                </div>

                <div class="d_user_icon_wrapper position-relative">
                    <div class="d_user_icon" id="db_user_icon" title="User Profile">
                        <i class="fas fa-user-circle"></i>
                    </div>

                    <div class="d_user_dropdown" id="db_user_dropdown">
                        <ul>
                            <li><a href="./auth/Login.html">Sign in</a></li>
                            <li><a href="./auth/ForgetPass.html">Change Password</a></li>
                            <li><a href="Profile.html">My Profile</a></li>
                            <li><a href="#">Logout</a></li>
                        </ul>
                    </div>
                </div>

            </nav>

            <!-- Mobile Toggler -->
            <button class="d_toggler_btn d-lg-none" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <!-- Offcanvas Mobile Menu -->
        <aside class="d_offcanvas_menu" id="d_offcanvas_menu">
            <button class="close_btn" aria-label="Close Menu">&times;</button>
            <nav>
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link " href="landingpage.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="allProduct.html">Games</a></li>
                    <li class="nav-item"><a class="nav-link" href="About_us.html">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="./Contact_us.html">Contact</a></li>
                    <li class="nav-item px-2">
                        <!-- Chat Open Button -->
                        <button class="d_search_form btn_gem" id="navChatToggle">
                            Chatbox
                        </button>
                    </li>

                    <!-- Chatbox -->
                    <div class="chatbox" id="navChatbox">
                        <div class="chatbox-header">
                            ðŸŽ® GameStore AI
                            <span id="navCloseChat">âœ–</span>
                        </div>
                        <div class="chatbox-messages" id="navChatMessages">
                            <div class="message bot">Hi! Iâ€™m your gaming assistant. How can I help you today?</div>
                        </div>
                        <div class="chatbox-input">
                            <input type="text" id="navUserInput" placeholder="Type your message...">
                            <button id="navSendMessage">âž¤</button>
                        </div>
                    </div>

                    <script>
                        const navChatToggle = document.getElementById("navChatToggle");
                        const navChatbox = document.getElementById("navChatbox");
                        const navCloseChat = document.getElementById("navCloseChat");
                        const navSendMessageBtn = document.getElementById("navSendMessage");
                        const navUserInput = document.getElementById("navUserInput");
                        const navChatMessages = document.getElementById("navChatMessages");

                        // Open chat from navbar button
                        navChatToggle.addEventListener("click", () => {
                            // Remove 'active' class from .d_offcanvas_menu if it exists
                            const offcanvasMenu = document.querySelector(".d_offcanvas_menu");
                            if (offcanvasMenu && offcanvasMenu.classList.contains("active")) {
                                offcanvasMenu.classList.remove("active");
                            }

                            // Show chatbox
                            navChatbox.style.display = "flex";
                        });

                        // Close chat
                        navCloseChat.addEventListener("click", () => {
                            navChatbox.style.display = "none";
                        });

                        // Send message
                        function sendNavMessage() {
                            const message = navUserInput.value.trim();
                            if (message === "") return;

                            appendNavMessage(message, "user");
                            navUserInput.value = "";

                            setTimeout(() => {
                                let reply = getNavBotReply(message);
                                appendNavMessage(reply, "bot");
                            }, 800);
                        }

                        function appendNavMessage(text, sender) {
                            const msg = document.createElement("div");
                            msg.classList.add("message", sender);
                            msg.innerText = text;
                            navChatMessages.appendChild(msg);
                            navChatMessages.scrollTop = navChatMessages.scrollHeight;
                        }

                        function getNavBotReply(userMsg) {
                            userMsg = userMsg.toLowerCase();
                            if (userMsg.includes("game")) return "We have the latest trending games! ðŸŽ®";
                            if (userMsg.includes("offer") || userMsg.includes("discount")) return "Check out our deals page for discounts up to 50%! ðŸ”¥";
                            if (userMsg.includes("console")) return "We sell PS5, Xbox Series X, and Nintendo Switch consoles.";
                            return "Iâ€™m not sure, but I can connect you to a human agent. ðŸ˜Š";
                        }

                        navSendMessageBtn.addEventListener("click", sendNavMessage);
                        navUserInput.addEventListener("keypress", e => { if (e.key === "Enter") sendNavMessage(); });
                    </script>
                </ul>
            </nav>
            <form class="d_search_form_offcanvas">
                <input type="search" placeholder="Search games..." />
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
            <div class="d_social_icons_offcanvas">
                <a href="./Cart.html"><i class="fa fa-cart-plus"></i></a>
                <a href="Profile.html"><i class="fas fa-user-circle"></i></a>
            </div>
        </aside>
    </div>

    <!-- Hero Section Start -->
    <div class="Z_cards_hero">
        <div class="Z_cart_hero-overlay">
            <h1 class="Z_about_title">Yoyo Store</h1>
        </div>
    </div>

    <div class="s_body_img py-5 text-white">
        <div class="a_header_container">
            <div class="row">
                <div class="col-xl-3 col-lg-4 d-none d-lg-block">
                    <div class=" p-4">
                        <div class="accordion s_accordion" id="accordionExample">
                            <!-- Price Filter -->
                            <div class="accordion-item" style="border: 1px solid #ad9d79;">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        <h5> Price</h5>
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show"
                                    data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <ul class="ps-0">
                                            <li><input type="checkbox" name="price" value="0-99"> $0 - $99</li>
                                            <li><input type="checkbox" name="price" value="100-199"> $100 - $199</li>
                                            <li><input type="checkbox" name="price" value="200-299"> $200 - $299</li>
                                            <li><input type="checkbox" name="price" value="300-399"> $300 - $399</li>
                                            <li><input type="checkbox" name="price" value="400-499"> $400 - $499</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Filter -->
                            <div class="accordion-item" style="border: 1px solid #ad9d79;">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        <h5>Category</h5>
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse"
                                    data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <ul class="ps-0" id="categoryFilterListDesktop"></ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="offcanvas offcanvas-start d-lg-none d_offcan_width" tabindex="-1" id="filterOffcanvas"
                    aria-labelledby="filterOffcanvasLabel">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title text-white" id="filterOffcanvasLabel">Filters</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                        <div class="accordion s_accordion" id="accordionExampleMobile">
                            <!-- Price Filter -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseMobileOne" aria-expanded="true"
                                        aria-controls="collapseMobileOne">
                                        <h5 class="mb-0"> Price</h5>
                                    </button>
                                </h2>
                                <div id="collapseMobileOne" class="accordion-collapse collapse show"
                                    data-bs-parent="#accordionExampleMobile">
                                    <div class="accordion-body">
                                        <ul class="ps-0">
                                            <li><input type="checkbox" name="price" value="0-99"> $0 - $99</li>
                                            <li><input type="checkbox" name="price" value="100-199"> $100 - $199</li>
                                            <li><input type="checkbox" name="price" value="200-299"> $200 - $299</li>
                                            <li><input type="checkbox" name="price" value="300-399"> $300 - $399</li>
                                            <li><input type="checkbox" name="price" value="400-499"> $400 - $499</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Filter -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseMobileTwo" aria-expanded="false"
                                        aria-controls="collapseMobileTwo">
                                        <h5 class="mb-0">Category</h5>
                                    </button>
                                </h2>
                                <div id="collapseMobileTwo" class="accordion-collapse collapse"
                                    data-bs-parent="#accordionExampleMobile">
                                    <div class="accordion-body">
                                        <ul class="ps-0" id="categoryFilterListMobile"></ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Product Display Area -->
                <div class="col-xl-9 col-lg-8">
                    <div class="d-flex px-md-4 justify-content-between align-items-center mb-3">
                        <div class="d-block d-lg-none">
                            <button class="btn border text-white" type="button" data-bs-toggle="offcanvas"
                                data-bs-target="#filterOffcanvas" aria-controls="filterOffcanvas">Filters
                            </button>
                        </div>
                        <div class="dropdown s_sort-dropdown">
                            <button class="btn btn-dark dropdown-toggle" type="button" id="sortDropdownBtn"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Sort By: <span id="selectedSort" style="color: #ad9d79;">Featured</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="sortDropdownBtn">
                                <li><a class="dropdown-item active" href="#" data-value="featured">Featured</a></li>
                                <li><a class="dropdown-item" href="#" data-value="name-asc">Alphabetically, A-Z</a></li>
                                <li><a class="dropdown-item" href="#" data-value="name-desc">Alphabetically, Z-A</a>
                                </li>
                                <li><a class="dropdown-item" href="#" data-value="price-asc">Price, low to high</a></li>
                                <li><a class="dropdown-item" href="#" data-value="price-desc">Price, high to low</a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Products Count -->
                    <div class="mb-3 px-md-4">
                        <span id="productCount" class="text-white">Loading...</span>
                    </div>

                    <!-- Grid View -->
                    <div id="gridContainer" class="row product-list"></div>

                    <ul class="pagination" id="pagination"></ul>

                </div>
            </div>
        </div>
    </div>

    <footer class="d_footer text-white">
        <div class="container py-md-3 ">
            <div class="row gy-4">
                <div class="col-md-4">
                    <h4 class="d_footer-logo mb-3">YOYO</h4>
                    <p class="d_footer_text">A realm where ancient horrors dwell and forgotten heroes rise again.
                        Unleash your legend in the shadows.</p>
                </div>
                <div class="col-md-2 col-6">
                    <h5 class="text-white mb-3">Quick Links</h5>
                    <ul class="list-unstyled d_footer-links">
                        <li><a href="landingpage.html">Home</a></li>
                        <li><a href="games.html" class="active">Games</a></li>
                        <li><a href="About_us.html">About</a></li>
                        <li><a href="Contact_us.html">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-6">
                    <h5 class="text-white mb-3">Our Policy</h5>
                    <ul class="list-unstyled d_footer-links">
                        <li><a href="landingpage.html">Home</a></li>
                        <li><a href="blog.html">Blog</a></li>
                        <li><a href="Privacy.html">Privacy</a></li>
                        <li><a href="services.html">Service</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="text-white mb-3">Contact</h5>
                    <ul class="list-unstyled d_footer-links d_footer_text">
                        <li><i class="fas fa-envelope me-2"></i> support@yoyo.com</li>
                        <li><i class="fas fa-phone me-2"></i> +91 98765 43210</li>
                        <li><i class="fas fa-location-dot me-2"></i> Yoyo HQ, Darkrealm</li>
                    </ul>
                    <div class="d_footer-social mt-3">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-x-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                    </div>
                </div>
            </div>
            <hr class="border-secondary mt-4" />
            <div class="text-center d_footer_text small">
                &copy; 2025 YOYO. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>



    <script>
        // Global variables
        let allProducts = [];
        let allCategories = [];
        let filteredProducts = [];
        let currentSort = 'featured';

        // Initialize the application
        document.addEventListener("DOMContentLoaded", function () {
            initializeApp();
        });

        async function initializeApp() {
            try {
                // Fetch data
                const [products, categories] = await Promise.all([
                    fetch("http://localhost:4000/products").then(res => res.json()),
                    fetch("http://localhost:4000/categories").then(res => res.json())
                ]);

                allProducts = products;
                allCategories = categories;
                filteredProducts = [...allProducts];

                // Initialize UI
                renderCategoryFilters();
                renderProducts();
                setupEventListeners();

                // Initialize user info
                initializeUserInfo();
            } catch (error) {
                console.error('Failed to initialize app:', error);
                document.getElementById('productCount').textContent = 'Failed to load products';
            }
        }

        function renderCategoryFilters() {
            const desktopList = document.getElementById("categoryFilterListDesktop");
            const mobileList = document.getElementById("categoryFilterListMobile");

            const categoryHTML = allCategories.map(cat =>
                `<li><input type="checkbox" name="category" value="${cat.id}"> ${cat.name}</li>`
            ).join('');

            if (desktopList) desktopList.innerHTML = categoryHTML;
            if (mobileList) mobileList.innerHTML = categoryHTML;
        }

        function applyFilters() {
            // Get selected filters
            const selectedPrices = Array.from(document.querySelectorAll('input[name="price"]:checked')).map(i => i.value);
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(i => Number(i.value));

            // Filter products
            filteredProducts = allProducts.filter(product => {
                // Price filter
                const priceMatch = selectedPrices.length === 0 || selectedPrices.some(range => {
                    const [min, max] = range.split('-').map(Number);
                    return product.price >= min && product.price <= max;
                });

                // Category filter
                const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(product.cat_id);

                return priceMatch && categoryMatch;
            });

            // Apply sorting
            applySorting();

            // Reset to first page when filters change
            renderProducts();
        }

        function applySorting() {
            switch (currentSort) {
                case 'name-asc':
                    filteredProducts.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'name-desc':
                    filteredProducts.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'price-asc':
                    filteredProducts.sort((a, b) => Number(a.price) - Number(b.price));
                    break;
                case 'price-desc':
                    filteredProducts.sort((a, b) => Number(b.price) - Number(a.price));
                    break;
                default:
                    // Featured or default - keep original order
                    break;
            }
        }

        function renderProducts() {
            const gridContainer = document.getElementById('gridContainer');
            const productCount = document.getElementById('productCount');
            const pagination = document.getElementById('pagination');

            // Clear containers
            gridContainer.innerHTML = "";
            pagination.innerHTML = "";

            const productsPerPage = 12;
            const totalProducts = filteredProducts.length;
            const totalPages = Math.ceil(totalProducts / productsPerPage);

            // Get current page from URL or default to 1
            const urlParams = new URLSearchParams(window.location.search);
            let currentPage = parseInt(urlParams.get('page')) || 1;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            // Calculate start and end indices
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = Math.min(startIndex + productsPerPage, totalProducts);

            // Get products for current page
            const currentPageProducts = filteredProducts.slice(startIndex, endIndex);

            // Update product count
            productCount.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalProducts} products`;

            // Create category map
            const catMap = {};
            allCategories.forEach(cat => { catMap[cat.id] = cat.name; });

            // Render products for current page
            currentPageProducts.forEach(product => {
                const categoryName = catMap[product.cat_id] || "Unknown";
                gridContainer.innerHTML += `
                    <div class="col-xl-4 col-lg-6 col-md-4 col-sm-6 col-12 mb-4 d-flex justify-content-center">
                        <div class="game-card position-relative" data-id="${product.id}">
                            <img src="${product.image}" alt="${product.title}" class="card-img-top" />
                            <div class="position-absolute card-content">
                                <div class="icons d-flex gap-2 mb-3">
                                    <i class="fa-brands fa-apple"></i>
                                    <i class="fa-brands fa-windows"></i>
                                </div>
                                <h3>${product.title}</h3>
                                <h3 class="mb-0">${Number(product.price).toFixed(2)}</h3>
                                <span class="badge bg-secondary mt-2">${categoryName}</span>
                            </div>
                            <div class="card-actions d-flex align-items-center gap-3">
                                <div class="d_main_button w-100">
                                    <button class="custom-cart-btn w-100" data-id="${product.id}">ADD TO CART</button>
                                    <div class="d_border"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Generate pagination
            if (totalPages > 1) {
                generatePagination(currentPage, totalPages);
            }

            // Add event listeners to product cards and buttons
            addProductEventListeners();
        }

       function generatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    function addButton(page, text, disabled) {
        const li = document.createElement('li');
        li.className = `page-item ${disabled ? 'disabled' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.innerHTML = text;
        if (!disabled) {
            a.href = '#';
            a.onclick = (e) => {
                e.preventDefault();
                const url = new URL(window.location);
                url.searchParams.set('page', page);
                window.history.pushState({}, '', url);
                renderProducts();
            };
        }
        li.appendChild(a);
        pagination.appendChild(li);
    }

    // Previous Button
    addButton(currentPage - 1, '<i class="fa fa-angle-left"></i>', currentPage === 1);

    // Middle text "X of Y"
    const middle = document.createElement('li');
    middle.className = 'page-item';
    middle.innerHTML = `<span class="page-link">${currentPage} of ${totalPages}</span>`;
    pagination.appendChild(middle);

    // Next Button
    addButton(currentPage + 1, '<i class="fa fa-angle-right"></i>', currentPage === totalPages);
}

        function addProductEventListeners() {
            // Add click event to product cards for navigation
            document.querySelectorAll('.game-card').forEach(card => {
                card.addEventListener('click', function (e) {
                    // Prevent navigation if the click was on the ADD TO CART button
                    if (e.target.closest('.custom-cart-btn')) return;

                    const id = this.getAttribute('data-id');
                    // Store item id for single product page
                    if (typeof Storage !== "undefined") {
                        localStorage.setItem('item_id', id);
                    }
                    window.location.href = 'singleProduct.html';
                });
            });

            // Add click event to cart buttons
            document.querySelectorAll('.custom-cart-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const pro_id = Number(this.getAttribute('data-id'));
                    await addToCart(pro_id);
                });
            });
        }

        async function addToCart(pro_id) {
            try {
                // Get user id from localStorage
                const user_id = Number(localStorage.getItem('user_id'));
                if (!user_id) {
                    alert('Please log in to add to cart!');
                    return;
                }

                // Check if user already has a cart
                let cartRes = await fetch(`http://localhost:4000/cart?user_id=${user_id}`);
                let carts = await cartRes.json();
                let cart = carts[0];

                if (cart) {
                    // Update existing cart
                    let products = cart.products || [];
                    let found = false;

                    products = products.map(item => {
                        if (item.pro_id === pro_id) {
                            found = true;
                            return { ...item, quantity: item.quantity + 1 };
                        }
                        return item;
                    });

                    if (!found) {
                        products.push({ pro_id, quantity: 1 });
                    }

                    await fetch(`http://localhost:4000/cart/${cart.id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ products })
                    });
                } else {
                    // Create new cart
                    await fetch('http://localhost:4000/cart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id,
                            products: [{ pro_id, quantity: 1 }]
                        })
                    });
                }

                alert('Added to cart!');
            } catch (error) {
                console.error('Error adding to cart:', error);
                alert('Failed to add to cart. Please try again.');
            }
        }

        function setupEventListeners() {
            // Filter change listeners
            document.body.addEventListener('change', function (e) {
                if (e.target.name === 'category' || e.target.name === 'price') {
                    applyFilters();
                }
            });

            // Sort dropdown listeners
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', e => {
                    e.preventDefault();

                    // Remove active class from all
                    document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));

                    // Add active to selected
                    item.classList.add('active');

                    // Update visible text and sort value
                    const label = item.textContent;
                    currentSort = item.getAttribute('data-value');
                    document.getElementById('selectedSort').textContent = label;

                    // Apply new sorting
                    applyFilters();
                });
            });

            // Mobile menu functionality
            setupMobileMenu();

            // User dropdown functionality
            setupUserDropdown();
        }

        function setupMobileMenu() {
            const toggler = document.querySelector('.d_toggler_btn');
            const offcanvas = document.getElementById('d_offcanvas_menu');
            const closeBtn = offcanvas?.querySelector('.close_btn');

            if (toggler && offcanvas && closeBtn) {
                toggler.addEventListener('click', () => {
                    offcanvas.classList.add('active');
                    document.body.style.overflow = 'hidden';
                });

                closeBtn.addEventListener('click', () => {
                    offcanvas.classList.remove('active');
                    document.body.style.overflow = '';
                });

                document.addEventListener('click', (e) => {
                    if (!offcanvas.contains(e.target) && !toggler.contains(e.target)) {
                        offcanvas.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        offcanvas.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            }
        }

        function setupUserDropdown() {
            const dbUserIcon = document.getElementById('db_user_icon');
            const dbUserDropdown = document.getElementById('db_user_dropdown');

            if (dbUserIcon && dbUserDropdown) {
                dbUserIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dbUserDropdown.style.display = dbUserDropdown.style.display === 'block' ? 'none' : 'block';
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    dbUserDropdown.style.display = 'none';
                });
            }
        }

        async function initializeUserInfo() {
            const userId = localStorage.getItem('user_id');
            const userIconDiv = document.getElementById('db_user_icon');

            if (userId && userIconDiv) {
                try {
                    const res = await fetch(`http://localhost:4000/users/${userId}`);
                    if (res.ok) {
                        const user = await res.json();
                        if (user.email && user.email.length > 0) {
                            userIconDiv.innerHTML = `<span style="font-size:20px;font-weight:200;display:inline-block;width:2.2rem;height:2.2rem;line-height:2.2rem;text-align:center;background:#ad9d79;color:#fff;border-radius:50%;">${user.email[0].toUpperCase()}</span>`;
                        }
                    }
                } catch (e) {
                    console.error('Failed to load user info:', e);
                }
            }
        }

        // Logout functionality
        document.querySelectorAll('a').forEach(function (link) {
            if (link.textContent.trim().toLowerCase() === 'logout') {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    localStorage.removeItem('user_id');
                    window.location.href = 'landingpage.html';
                });
            }
        });

        // Sticky header scroll effect
        window.addEventListener('scroll', () => {
            const header = document.querySelector('.d_header');
            if (header) {
                if (window.scrollY > 20) {
                    header.classList.add('d_scrolled');
                } else {
                    header.classList.remove('d_scrolled');
                }
            }
        });
    </script>

</body>

</html>