<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Games Store</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/s_style.css" />
    <link rel="stylesheet" href="./css/z_style.css" />
    <link rel="stylesheet" href="./css/d_style.css">

    <style>
        .offcanvas {
            --bs-offcanvas-width: 350px;
            background-color: #1a1a1a;
        }

        @media (max-width: 991px) {
            .a_header_container {
                padding: 0px 8% !important;
            }
        }

        @media (max-width:375px) {
            .offcanvas {
                --bs-offcanvas-width: 300px;
            }
        }

        @media (max-width:320px) {
            .offcanvas {
                --bs-offcanvas-width: 280px;
            }
        }
    </style>
</head>

<body>
    <div class="d_main">
        <!-- Header -->
        <header class="d_header d-flex align-items-center justify-content-between">
            <div class="d_logo">
                <i class="fas fa-dragon"></i> GameForge
            </div>

            <!-- Desktop Nav -->
            <nav class="d_navbar navbar navbar-expand-lg d-none d-lg-flex">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link " href="landingpage.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="allProduct.html">Games</a></li>
                    <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="About_us.html">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="./Contact_us.html">Contact</a></li>
                </ul>

                <form class="d_search_form ">
                    <input type="search" placeholder="Search games..." />
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>

                <div class="d_social_icons me-3">
                    <a href="./Cart.html"><i class="fa fa-cart-plus"></i></a>
                </div>

                <div class="d_user_icon_wrapper position-relative">
                    <div class="d_user_icon" id="db_user_icon" title="User Profile">
                        <i class="fas fa-user-circle"></i>
                    </div>

                    <div class="d_user_dropdown" id="db_user_dropdown">
                        <ul>
                            <li><a href="./auth/Login.html">Sign in</a></li>
                            <li><a href="./auth/ForgetPass.html">Change Password</a></li>
                            <li><a href="Profile.html">My Profile</a></li>
                            <li><a href="#">Logout</a></li>
                        </ul>
                    </div>
                </div>

            </nav>

            <!-- Mobile Toggler -->
            <button class="d_toggler_btn d-lg-none" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
        </header>

        <!-- Offcanvas Mobile Menu -->
        <aside class="d_offcanvas_menu" id="d_offcanvas_menu">
            <button class="close_btn" aria-label="Close Menu">&times;</button>
            <nav>
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link " href="landingpage.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="allProduct.html">Games</a></li>
                    <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="About_us.html">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="./Contact_us.html">Contact</a></li>
                </ul>
            </nav>
            <form class="d_search_form_offcanvas">
                <input type="search" placeholder="Search games..." />
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
            <div class="d_social_icons_offcanvas">
                <a href="./Cart.html"><i class="fa fa-cart-plus"></i></a>
                <a href="Profile.html"><i class="fas fa-user-circle"></i></a>
            </div>
        </aside>
    </div>
    <!-- Hero Section Start -->
    <div class="Z_cards_hero">
        <div class="Z_cart_hero-overlay">
            <h1 class="Z_about_title">GameForge Store</h1>
        </div>
    </div>

    <div class="s_body_img py-5 text-white">
        <!-- <div class="py-5">
            <h2 class="text-center" style="color: #ad9d79;">Games Store</h2>
        </div> -->
        <div class="a_header_container">
            <div class="row">
                <div class="col-xl-3 col-lg-4 d-none d-lg-block">
                    <div class=" p-4">
                        <div class="accordion s_accordion" id="accordionExample">
                            <!-- Price Filter -->
                            <div class="accordion-item" style="border: 1px solid #ad9d79;">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        <h5> Price</h5>
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show"
                                    data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <ul class="ps-0">
                                            <li><input type="checkbox" name="price" value="0-99"> $0 - $99</li>
                                            <li><input type="checkbox" name="price" value="100-199"> $100 - $199</li>
                                            <li><input type="checkbox" name="price" value="200-299"> $200 - $299</li>
                                            <li><input type="checkbox" name="price" value="300-399"> $300 - $399</li>
                                            <li><input type="checkbox" name="price" value="400-499"> $400 - $499</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Filter -->
                            <div class="accordion-item" style="border: 1px solid #ad9d79;">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        <h5>Category</h5>
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse"
                                    data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <ul class="ps-0" id="categoryFilterListDesktop"></ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="offcanvas offcanvas-start d-lg-none d_offcan_width" tabindex="-1" id="filterOffcanvas"
                    aria-labelledby="filterOffcanvasLabel">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title text-white" id="filterOffcanvasLabel">Filters</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                        <div class="accordion s_accordion" id="accordionExampleMobile">
                            <!-- Price Filter -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseMobileOne" aria-expanded="true"
                                        aria-controls="collapseMobileOne">
                                        <h5 class="mb-0"> Price</h5>
                                    </button>
                                </h2>
                                <div id="collapseMobileOne" class="accordion-collapse collapse show"
                                    data-bs-parent="#accordionExampleMobile">
                                    <div class="accordion-body">
                                        <ul class="ps-0">
                                            <li><input type="checkbox" name="price" value="0-99"> $0 - $99</li>
                                            <li><input type="checkbox" name="price" value="100-199"> $100 - $199</li>
                                            <li><input type="checkbox" name="price" value="200-299"> $200 - $299</li>
                                            <li><input type="checkbox" name="price" value="300-399"> $300 - $399</li>
                                            <li><input type="checkbox" name="price" value="400-499"> $400 - $499</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Category Filter -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseMobileTwo" aria-expanded="false"
                                        aria-controls="collapseMobileTwo">
                                        <h5 class="mb-0">Category</h5>
                                    </button>
                                </h2>
                                <div id="collapseMobileTwo" class="accordion-collapse collapse"
                                    data-bs-parent="#accordionExampleMobile">
                                    <div class="accordion-body">
                                        <ul class="ps-0" id="categoryFilterListMobile"></ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <!-- Product Display Area -->

                <div class="col-xl-9 col-lg-8">
                    <div class="d-flex px-md-4  justify-content-between align-items-center mb-3">
                        <div class="d-none">
                            <i id="gridView" class="fa-solid fa-grip active mx-2 text-white"></i>
                            <i id="listView" class="fa-solid fa-list me-2 text-white d-md-block d-none"></i>
                        </div>
                        <!-- <div class="mb-3">
                            <span id="productCount" >Showing 6 products</span>
                        </div> -->
                        <div class="d-block d-lg-none">
                            <button class="btn border text-white" type="button" data-bs-toggle="offcanvas"
                                data-bs-target="#filterOffcanvas" aria-controls="filterOffcanvas">Filters
                            </button>
                        </div>
                        <div class="dropdown s_sort-dropdown">
                            <button class="btn btn-dark dropdown-toggle" type="button" id="sortDropdownBtn"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Sort By: <span id="selectedSort" style="color: #ad9d79;">Featured</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="sortDropdownBtn">
                                <li><a class="dropdown-item active" href="#" data-value="featured">Featured</a></li>
                                <li><a class="dropdown-item" href="#" data-value="name-asc">Alphabetically, A-Z</a></li>
                                <li><a class="dropdown-item" href="#" data-value="name-desc">Alphabetically, Z-A</a>
                                </li>
                                <li><a class="dropdown-item" href="#" data-value="price-asc">Price, low to high</a></li>
                                <li><a class="dropdown-item" href="#" data-value="price-desc">Price, high to low</a>
                                </li>
                            </ul>

                        </div>

                    </div>

                    <!-- Products Count -->


                    <!-- Grid View -->
                    <div id="gridContainer" class="row"></div>

                    <!-- List View -->
                    <div id="listContainer" class="d-none"></div>
                </div>
            </div>
        </div>
    </div>
    <footer class="d_footer text-white">
        <div class="container py-md-3 ">
            <div class="row gy-4">
                <div class="col-md-4">
                    <h4 class="d_footer-logo mb-3">GAMEFORGE</h4>
                    <p class="d_footer_text">A realm where ancient horrors dwell and forgotten heroes rise again.
                        Unleash your
                        legend in the shadows.</p>
                </div>
                <div class="col-md-2 col-6">
                    <h5 class="text-white mb-3">Quick Links</h5>
                    <ul class="list-unstyled d_footer-links">
                        <li><a href="landingpage.html">Home</a></li>
                        <li><a href="games.html" class="active">Games</a></li>
                        <li><a href="About_us.html">About</a></li>
                        <li><a href="Contact_us.html">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-2 col-6">
                    <h5 class="text-white mb-3">Our Policy</h5>
                    <ul class="list-unstyled d_footer-links">
                        <li><a href="landingpage.html">Home</a></li>
                        <li><a href="Contact_us.html">Blog</a></li>
                        <li><a href="Privacy.html">Privacy</a></li>
                        <li><a href="services.html">Service</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="text-white mb-3">Contact</h5>
                    <ul class="list-unstyled d_footer-links d_footer_text">
                        <li><i class="fas fa-envelope me-2"></i> support@gameforge.com</li>
                        <li><i class="fas fa-phone me-2"></i> +91 98765 43210</li>
                        <li><i class="fas fa-location-dot me-2"></i> GameForge HQ, Darkrealm</li>
                    </ul>
                    <div class="d_footer-social mt-3">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-x-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                    </div>
                </div>
            </div>
            <hr class="border-secondary mt-4" />
            <div class="text-center d_footer_text small">
                &copy; 2025 GAMEFORGE. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Logout functionality
        document.querySelectorAll('a').forEach(function (link) {
            if (link.textContent.trim().toLowerCase() === 'logout') {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    localStorage.removeItem('user_id');
                    window.location.href = 'landingpage.html';
                });
            }
        });
    </script>
    <script>
        // Show first letter of user email in user icon if logged in
        document.addEventListener('DOMContentLoaded', async function () {
            const userId = localStorage.getItem('user_id');
            const userIconDiv = document.getElementById('db_user_icon');
            if (userId && userIconDiv) {
                try {
                    const res = await fetch(`http://localhost:4000/users/${userId}`);
                    if (res.ok) {
                        const user = await res.json();
                        if (user.email && user.email.length > 0) {
                            userIconDiv.innerHTML = `<span style="font-size:20px;font-weight:200;display:inline-block;width:2.2rem;height:2.2rem;line-height:2.2rem;text-align:center;background:#ad9d79;color:#fff;border-radius:50%;">${user.email[0].toUpperCase()}</span>`;
                        }
                    }
                } catch (e) {
                    // fallback: keep icon
                }
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            Promise.all([
                fetch("http://localhost:4000/products").then(res => res.json()),
                fetch("http://localhost:4000/categories").then(res => res.json())
            ]).then(([products, categories]) => {
                // Map category id to name for quick lookup
                const catMap = {};
                categories.forEach(cat => { catMap[cat.id] = cat.name; });

                // Render product cards
                const gridContainer = document.getElementById('gridContainer');
                const listContainer = document.getElementById('listContainer');
                gridContainer.innerHTML = "";
                listContainer.innerHTML = "";

                products.forEach(product => {
                    const categoryName = catMap[product.cat_id] || "Unknown";
                    // Grid Card
                    gridContainer.innerHTML += `
                        <div class="col-lg-4 col-md-6 col-sm-6 col-12 mb-4 d-flex justify-content-center">
                          <div class="game-card position-relative">
                            <img src="${product.image}" alt="${product.title}" class="card-img-top" />
                            <div class="position-absolute card-content">
                              <div class="icons d-flex gap-2 mb-3">
                                <i class="fa-brands fa-apple"></i>
                                <i class="fa-brands fa-windows"></i>
                              </div>
                              <h3>${product.title}</h3>
                              <h3 class="mb-0">$${product.price.toFixed(2)}</h3>
                              <span class="badge bg-secondary mt-2">${categoryName}</span>
                            </div>
                            <div class="card-actions d-flex align-items-center gap-3">
                              <div class="d_main_button w-100">
                                <button class="custom-cart-btn w-100" onclick="addToCart(${product.id})">ADD TO CART</button>
                                <div class="d_border"></div>
                              </div>
                              <!-- <i class="fa-regular fa-heart text-white" onclick="toggleWishlist(${product.id})"></i>
                              <i class="fa-solid fa-ellipsis text-white"></i> -->
                            </div>
                          </div>
                        </div>
                    `;
                    // List Card
                    listContainer.innerHTML += `
                        <div class="card mb-3 list-card border-1 border-light" style="background: rgba(34,34,34,0.92); color:#fff; border:none;">
                          <div class="row g-0 align-items-center">
                            <div class="col-sm-4 d-flex align-items-center justify-content-center" style="min-height:180px;">
                              <div style="background:rgba(24,24,24,0.95); border-radius:16px; padding:12px; display:flex; align-items:center; justify-content:center; width:130px; height:130px;">
                                <img src="${product.image}" alt="${product.title}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; box-shadow:0 2px 8px rgba(0,0,0,0.2); background:#181818;" />
                              </div>
                            </div>
                            <div class="col-sm-8">
                              <div class="card-body d-flex flex-column justify-content-between h-100" style="min-height: 160px;">
                                <div>
                                  <h5 class="card-title mb-2" style="color:#ad9d79;">${product.title}</h5>
                                  <p class="card-text fw-bold mb-1 text-white">$${product.price.toFixed(2)}</p>
                                  <p class="card-text mb-2 text-white"><small>${product.description}</small></p>
                                  <span class="badge bg-secondary">${categoryName}</span>
                                </div>
                                <div class="d-flex align-items-center gap-3 mt-auto">
                                  <button class="btn btn-sm s_cart_btn" onclick="addToCart(${product.id})">ADD TO CART</button>
                                  <i class="fa-regular fa-heart fs-5" onclick="toggleWishlist(${product.id})" style="cursor:pointer;"></i>
                                  <i class="fa-solid fa-eye fs-6" onclick="viewDetails(${product.id})" style="cursor:pointer;"></i>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                    `;
                });
            });
        });

        // Dummy functions for cart/wishlist/details (replace with your real logic)
        function addToCart(id) { alert('Add to cart: ' + id); }
        function toggleWishlist(id) { alert('Wishlist: ' + id); }
        function viewDetails(id) { alert('View details: ' + id); }

        const gridBtn = document.getElementById('gridView');
        const listBtn = document.getElementById('listView');
        const gridContainer = document.getElementById('gridContainer');
        const listContainer = document.getElementById('listContainer');

        function createGridCard(cardData) {
            return `
            <div class="col-12 col-sm-6 col-md-4 col-lg-6 col-xl-4  mb-4 d-flex justify-content-center">
              <div class="game-card position-relative">
                <img src="${cardData.image}" alt="${cardData.title}" class="card-img-top" />
                <div class="position-absolute card-content">
                  <div class="icons d-flex gap-2 mb-3">
                    <i class="fa-brands fa-apple"></i>
                    <i class="fa-brands fa-windows"></i>
                  </div>
                  <h3>${cardData.title}</h3>
                  <h3 class="mb-0">${cardData.price}</h3>
                </div>
                <div class="card-actions d-flex align-items-center gap-3">
                  <div class="d_main_button w-100" >
                    <button class="custom-cart-btn w-100" onclick="addToCart(${cardData.id})">ADD TO CART</button>
                    <div class="d_border"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        function createListCard(cardData) {
            return `
        <div class="card mb-3 list-card border-1 border-light " style="background: rgba(34,34,34,0.92) url('../images/inner-background-img-3.jpg'); background-blend-mode: darken, normal; color:#fff; border:none; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.35), 0 1.5px 6px 0 rgba(0,0,0,0.25);">
          <div class="row g-0 align-items-center">
            <div class="col-sm-4 d-flex align-items-center justify-content-center" style="min-height:180px;">
              <div style="background:rgba(24,24,24,0.95); border-radius:16px; padding:12px; display:flex; align-items:center; justify-content:center; width:130px; height:130px;">
                <img src="${cardData.image}" alt="${cardData.title}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; box-shadow:0 2px 8px rgba(0,0,0,0.2); background:#181818;" />
              </div>
            </div>
            <div class="col-sm-8">
              <div class="card-body d-flex flex-column justify-content-between h-100" style="min-height: 160px;">
                <div>
                  <h5 class="card-title mb-2" style="color:#ad9d79;">${cardData.title}</h5>
                  <p class="card-text fw-bold mb-1 text-white" >${cardData.price}</p>
                  <p class="card-text mb-2 text-white"><small class="">${cardData.description}</small></p>
                </div>
                <div class="d-flex align-items-center gap-3 mt-auto">
                  <button class="btn btn-sm s_cart_btn text-nowrap" onclick="addToCart(${cardData.id})">ADD TO CART</button>
                                    <i class="fa-solid fa-eye fs-6" onclick="viewDetails(${cardData.id})"style="cursor:pointer;"></i>

                </div>
              </div>
            </div>
          </div>
        </div>`;
        }

        function addToCart(id) {
            const card = cardsData.find(c => c.id === id);
            if (!card) return;

            // First, check if the item is already in the cart
            fetch(`http://localhost:4000/cart?productId=${card.id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        // Item exists, increment quantity
                        const cartItem = data[0];
                        fetch(`http://localhost:4000/cart/${cartItem.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ quantity: cartItem.quantity + 1 })
                        })
                            .then(response => {
                                if (response.ok) {
                                    alert(`Increased quantity for "${card.title}" in cart!`);
                                } else {
                                    alert('Failed to update cart.');
                                }
                            });
                    } else {
                        // Item does not exist, add new
                        const newCartItem = {
                            productId: card.id,
                            title: card.title,
                            price: parseFloat(card.price.replace('$', '')),
                            quantity: 1,
                            image: card.image
                        };
                        fetch('http://localhost:4000/cart', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(newCartItem)
                        })
                            .then(response => {
                                if (response.ok) {
                                    alert(`Added "${card.title}" to cart!`);
                                } else {
                                    alert('Failed to add to cart.');
                                }
                            });
                    }
                })
                .catch(() => alert('Error connecting to cart API.'));
        }

        function toggleWishlist(id) {
            const card = cardsData.find(c => c.id === id);
            alert(`Added "${card.title}" to wishlist!`);
        }

        function viewDetails(id) {
            const card = cardsData.find(c => c.id === id);
            alert(`Viewing details for "${card.title}"`);
        }

        gridBtn.addEventListener('click', () => {
            gridContainer.classList.remove('d-none');
            listContainer.classList.add('d-none');
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
        });

        listBtn.addEventListener('click', () => {
            gridContainer.classList.add('d-none');
            listContainer.classList.remove('d-none');
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
        });

        function sortCards(cards, sortValue) {
            return [...cards].sort((a, b) => {
                const priceA = parseFloat(a.price.replace('$', ''));
                const priceB = parseFloat(b.price.replace('$', ''));
                const nameA = a.title.toLowerCase();
                const nameB = b.title.toLowerCase();

                switch (sortValue) {
                    case 'name-asc':
                        return nameA.localeCompare(nameB);
                    case 'name-desc':
                        return nameB.localeCompare(nameA);
                    case 'price-asc':
                        return priceA - priceB;
                    case 'price-desc':
                        return priceB - priceA;
                    default:
                        return 0;
                }
            });
        }
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', e => {
                e.preventDefault();

                // Remove active class from all
                document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));

                // Add active to selected
                item.classList.add('active');

                // Update visible text
                const label = item.textContent;
                const value = item.getAttribute('data-value');
                document.getElementById('selectedSort').textContent = label;

                // Set value manually to trigger sorting
                filterCards(value);
            });
        });
        function filterCards() {
            const selectedPrices = Array.from(document.querySelectorAll('input[name="price"]:checked')).map(i => i.value);
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(i => i.value);
            const sortValue = document.querySelector('.dropdown-item.active')?.dataset.value || "featured";


            const filtered = cardsData.filter(card => {
                const price = parseFloat(card.price.replace('$', ''));
                const priceMatch = selectedPrices.length === 0 || selectedPrices.some(range => {
                    const [min, max] = range.split('-').map(Number);
                    return price >= min && price <= max;
                });

                const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(card.category);

                return priceMatch && categoryMatch;
            });

            const sorted = sortCards(filtered, sortValue);
            gridContainer.innerHTML = sorted.map(createGridCard).join('');
            listContainer.innerHTML = sorted.map(createListCard).join('');
            document.getElementById('productCount').innerText = `Showing ${sorted.length} products`;
        }

        // Initialize
        filterCards();

        // Sort dropdown event
        document.getElementById('sortSelect').addEventListener('change', filterCards);

        // Checkbox filter event binding
        const allFilters = document.querySelectorAll('input[name="price"], input[name="category"]');
        allFilters.forEach(input => {
            input.addEventListener('change', filterCards);
        });


    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch("http://localhost:4000/categories")
                .then(res => res.json())
                .then(categories => {
                    // Desktop filter
                    const filterListDesktop = document.getElementById("categoryFilterListDesktop");
                    if (filterListDesktop) {
                        filterListDesktop.innerHTML = "";
                        categories.forEach(cat => {
                            filterListDesktop.innerHTML += `
                                <li>
                                    <input type="checkbox" name="category" value="${cat.id}"> ${cat.name}
                                </li>
                            `;
                        });
                    }
                    // Mobile filter
                    const filterListMobile = document.getElementById("categoryFilterListMobile");
                    if (filterListMobile) {
                        filterListMobile.innerHTML = "";
                        categories.forEach(cat => {
                            filterListMobile.innerHTML += `
                                <li>
                                    <input type="checkbox" name="category" value="${cat.id}"> ${cat.name}
                                </li>
                            `;
                        });
                        // Add event listener to close offcanvas on selection
                        filterListMobile.addEventListener('change', function (e) {
                            const offcanvas = document.getElementById('filterOffcanvas');
                            if (offcanvas && typeof bootstrap !== 'undefined') {
                                const bsOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvas);
                                bsOffcanvas.hide();
                            } else if (offcanvas) {
                                // fallback: remove 'show' class if bootstrap js is not available
                                offcanvas.classList.remove('show');
                                offcanvas.style.visibility = 'hidden';
                            }
                        });
                    }
                });
        });

        let allProducts = [];
        let allCategories = [];

        function renderProducts(products, categories) {
            const catMap = {};
            categories.forEach(cat => { catMap[cat.id] = cat.name; });

            const gridContainer = document.getElementById('gridContainer');
            gridContainer.innerHTML = "";

            products.forEach(product => {
                const categoryName = catMap[product.cat_id] || "Unknown";
                gridContainer.innerHTML += `
            <div class="col-lg-4 col-md-6 col-sm-6 col-12 mb-4 d-flex justify-content-center">
              <div class="game-card position-relative">
                <img src="${product.image}" alt="${product.title}" class="card-img-top" />
                <div class="position-absolute card-content">
                  <h3>${product.title}</h3>
                  <h3 class="mb-0">$${product.price.toFixed(2)}</h3>
                  <span class="badge bg-secondary mt-2">${categoryName}</span>
                </div>
              </div>
            </div>
        `;
            });
        }

        function filterAndRenderProducts() {
            // Get checked categories (as numbers)
            const checkedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => Number(cb.value));
            // Get checked price ranges
            const checkedPrices = Array.from(document.querySelectorAll('input[name="price"]:checked')).map(cb => cb.value);

            let filtered = allProducts;

            // Category filter
            if (checkedCategories.length > 0) {
                filtered = filtered.filter(p => checkedCategories.includes(p.cat_id));
            }

            // Price filter
            if (checkedPrices.length > 0) {
                filtered = filtered.filter(p => {
                    return checkedPrices.some(range => {
                        const [min, max] = range.split('-').map(Number);
                        return p.price >= min && p.price <= max;
                    });
                });
            }

            renderProducts(filtered, allCategories);
        }

        document.addEventListener("DOMContentLoaded", function () {
            Promise.all([
                fetch("http://localhost:4000/products").then(res => res.json()),
                fetch("http://localhost:4000/categories").then(res => res.json())
            ]).then(([products, categories]) => {
                allProducts = products;
                allCategories = categories;
                renderCategoryFilters(categories);
                filterAndRenderProducts();
            });

            // Attach filter event listeners (delegated for dynamic checkboxes)
            document.body.addEventListener('change', function (e) {
                if (e.target.name === 'category' || e.target.name === 'price') {
                    filterAndRenderProducts();
                }
            });
        });
    </script>
    <script>
        (function () {
            const toggler = document.querySelector('.d_toggler_btn');
            const offcanvas = document.getElementById('d_offcanvas_menu');
            const closeBtn = offcanvas.querySelector('.close_btn');

            toggler.addEventListener('click', () => {
                offcanvas.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            closeBtn.addEventListener('click', () => {
                offcanvas.classList.remove('active');
                document.body.style.overflow = '';
            });

            document.addEventListener('click', (e) => {
                if (!offcanvas.contains(e.target) && !toggler.contains(e.target)) {
                    offcanvas.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    offcanvas.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });

            // Sticky header scroll effect
            window.addEventListener('scroll', () => {
                const header = document.querySelector('.d_header');
                if (window.scrollY > 20) {
                    header.classList.add('d_scrolled');
                } else {
                    header.classList.remove('d_scrolled');
                }
            });
        })();
    </script>
    <script>
        const dbUserIcon = document.getElementById('db_user_icon');
        const dbUserDropdown = document.getElementById('db_user_dropdown');

        dbUserIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            dbUserDropdown.style.display = dbUserDropdown.style.display === 'block' ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            dbUserDropdown.style.display = 'none';
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initial fetch and render
            fetchAndRenderProducts('featured');

            // Handle sort dropdown click
            document.querySelectorAll('.s_sort-dropdown .dropdown-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    // Remove active from all, add to selected
                    document.querySelectorAll('.s_sort-dropdown .dropdown-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    // Update label
                    document.getElementById('selectedSort').textContent = this.textContent;
                    // Fetch and render with selected sort
                    fetchAndRenderProducts(this.dataset.value);
                });
            });
        });

        function fetchAndRenderProducts(sortType) {
            Promise.all([
                fetch("http://localhost:4000/products").then(res => res.json()),
                fetch("http://localhost:4000/categories").then(res => res.json())
            ]).then(([products, categories]) => {
                // Sort products based on sortType
                let sortedProducts = [...products];
                switch (sortType) {
                    case 'name-asc':
                        sortedProducts.sort((a, b) => a.title.localeCompare(b.title));
                        break;
                    case 'name-desc':
                        sortedProducts.sort((a, b) => b.title.localeCompare(a.title));
                        break;
                    case 'price-asc':
                        sortedProducts.sort((a, b) => Number(a.price) - Number(b.price));
                        break;
                    case 'price-desc':
                        sortedProducts.sort((a, b) => Number(b.price) - Number(a.price));
                        break;
                    // 'featured' or default: no sorting or your own logic
                    default:
                        // Optionally, you can shuffle or keep as is for 'featured'
                        break;
                }
                renderProductCards(sortedProducts, categories);
            });
        }

        function renderProductCards(products, categories) {
            const catMap = {};
            categories.forEach(cat => { catMap[cat.id] = cat.name; });
            const gridContainer = document.getElementById('gridContainer');
            gridContainer.innerHTML = "";
            products.forEach(product => {
                const categoryName = catMap[product.cat_id] || "Unknown";
                gridContainer.innerHTML += `
                    <div class="col-lg-4 col-md-6 col-sm-6 col-12 mb-4 d-flex justify-content-center">
                      <div class="game-card position-relative" data-id="${product.id}">
                        <img src="${product.image}" alt="${product.title}" class="card-img-top" />
                        <div class="position-absolute card-content">
                          <h3>${product.title}</h3>
                          <h3 class="mb-0">$${Number(product.price).toFixed(2)}</h3>
                          <span class="badge bg-secondary mt-2">${categoryName}</span>
                        </div>
                        <div class="card-actions d-flex align-items-center gap-3">
                                <div class="d_main_button w-100">
                                    <button class="custom-cart-btn w-100" data-id="${product.id}">ADD TO CART</button>
                                    <div class="d_border"></div>
                                </div>
                            </div>
                      </div>
                    </div>
                `;
            });
            // Add click event to all .game-card elements for navigation
            document.querySelectorAll('.game-card').forEach(card => {
                card.addEventListener('click', function (e) {
                    // Prevent navigation if the click was on the ADD TO CART button
                    if (e.target.closest('.custom-cart-btn')) return;
                    const id = this.getAttribute('data-id');
                    localStorage.setItem('item_id', id);
                    window.location.href = 'singleProduct.html';
                });
            });
            // Add click event to all .custom-cart-btn buttons for cart functionality
            document.querySelectorAll('.custom-cart-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const pro_id = Number(this.getAttribute('data-id'));
                    console.log('Add to cart clicked, product id:', pro_id);
                    localStorage.setItem('cart_id', pro_id);
                    // 1. Get user id from localStorage
                    const user_id = Number(localStorage.getItem('user_id'));
                    if (!user_id) {
                        alert('Please log in to add to cart!');
                        return;
                    }

                    // 2. Check if user already has a cart
                    let cartRes = await fetch(`http://localhost:4000/cart?user_id=${user_id}`);
                    let carts = await cartRes.json();
                    let cart = carts[0];

                    if (cart) {
                        // 3. If cart exists, update products array
                        let products = cart.products || [];
                        let found = false;
                        products = products.map(item => {
                            if (item.pro_id === pro_id) {
                                found = true;
                                return { ...item, quantity: item.quantity + 1 };
                            }
                            return item;
                        });
                        if (!found) {
                            products.push({ pro_id, quantity: 1 });
                        }

                        // 4. Update cart in db
                        await fetch(`http://localhost:4000/cart/${cart.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ products })
                        });
                    } else {
                        // 5. If no cart, create new cart
                        await fetch('http://localhost:4000/cart', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id,
                                products: [{ pro_id, quantity: 1 }]
                            })
                        });
                    }

                    alert('Added to cart!');
                });
            });
        }
    </script>
</body>

</html>